<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Receipts Viewer — Amber → Gold</title>
<style>
  :root{
    --bg:#0b0c0f; --card:#111317; --muted:#6b7280; --text:#e5e7eb;
    --ok:#16a34a; --warn:#f59e0b; --gold:#d4af37; --err:#ef4444; --accent:#60a5fa;
    --border:#1f242c; --pill:#0f1720; --shadow:0 12px 30px rgba(0,0,0,.35);
  }
  html,body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
  .wrap{max-width:980px;margin:0 auto;padding:28px 18px 64px}
  header{display:flex;gap:18px;align-items:center;justify-content:space-between;margin-bottom:18px}
  .brand{display:flex;gap:12px;align-items:center}
  .dot{width:11px;height:11px;border-radius:50%;background:linear-gradient(135deg,#60a5fa,#a78bfa)}
  h1{font-size:20px;margin:0}
  .sub{color:var(--muted);font-size:14px;margin-top:2px}
  .hero{background:linear-gradient(180deg,rgba(96,165,250,.12),transparent 60%);border:1px solid var(--border);border-radius:14px;padding:16px 16px;margin:8px 0 18px}
  .hero p{margin:0;color:#c9d4e3}
  .grid{display:grid;grid-template-columns:1fr;gap:16px}
  @media(min-width:900px){.grid{grid-template-columns:1fr 320px}}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow)}
  .card .hd{display:flex;justify-content:space-between;align-items:center;padding:16px;border-bottom:1px solid var(--border)}
  .pill{display:inline-flex;gap:8px;align-items:center;background:var(--pill);border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-weight:600;font-size:12px;letter-spacing:.2px}
  .badge-green{color:#86efac;border-color:#14532d;background:rgba(22,163,74,.07)}
  .badge-amber{color:#fde68a;border-color:#7c580b;background:rgba(245,158,11,.10)}
  .badge-gold{color:#f9e8b2;border-color:#7a5f18;background:rgba(212,175,55,.10)}
  .badge-eval{color:#93c5fd;border-color:#1e3a8a;background:rgba(59,130,246,.10)}
  .badge-label{color:#c7d2fe;border-color:#312e81;background:rgba(99,102,241,.10)}
  .kv{display:grid;grid-template-columns:160px 1fr;gap:10px;padding:14px 16px;border-bottom:1px solid var(--border)}
  .kv:last-child{border-bottom:none}
  .k{color:var(--muted)}
  .v code{background:#0d1117;border:1px solid #1f2937;padding:2px 6px;border-radius:6px}
  .muted{color:var(--muted)}
  .btnrow{display:flex;flex-wrap:wrap;gap:12px;margin-top:8px}
  button,.btn{
    appearance:none;border:none;cursor:pointer;border-radius:12px;
    padding:14px 18px;font-weight:700;letter-spacing:.2px;
    background:#1b2330;color:#e5e7eb;border:1px solid #273142;min-width:160px
  }
  button.primary{background:#1d4ed8;border-color:#1e3a8a}
  button.warn{background:#7c2d12;border-color:#a16207}
  button.secondary{background:#111827;border-color:#253041}
  button:active{transform:translateY(1px)}
  .good{color:#86efac}.warnc{color:#fde68a}.err{color:#fb7185}
  .side{position:sticky;top:20px}
  .side .box{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px}
  .side label{display:block;font-size:12px;color:var(--muted);margin:8px 0 6px}
  input[type="text"]{width:100%;background:#0d1117;border:1px solid #253041;color:#e5e7eb;border-radius:10px;padding:12px 12px}
  .small{font-size:12px;color:var(--muted)}
  .list{margin-top:10px;display:flex;flex-direction:column;gap:8px}
  .item{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#0e1218}
  .tag{font-size:11px;padding:2px 8px;border:1px solid #334155;border-radius:999px;color:#cbd5e1}
  .status{font-size:12px;margin-left:6px}
  .sep{height:1px;background:var(--border);margin:14px 0}
  a{color:var(--accent);text-decoration:none}
  .foot{margin-top:26px;font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="dot" aria-hidden="true"></div>
      <div>
        <h1>Receipts Viewer</h1>
        <div class="sub">Amber → Eval → Label → <span style="color:var(--gold)">Gold</span></div>
      </div>
    </div>
    <div class="sub">Portable proof. No prompts or PII.</div>
  </header>

  <div class="hero">
    <p><strong>How to read this:</strong> Each card is a tiny, signed record of a step in the learning loop.
      <span class="muted">AR = Amber (uncertain case), EVR = Eval (variant test), LBR = Label (adjudication), GPR = Gold (promoted for training).</span>
    </p>
  </div>

  <div class="grid">
    <div class="card" id="card">
      <div class="hd">
        <div id="pill" class="pill">Loading…</div>
        <div class="muted" id="rid">—</div>
      </div>
      <div class="kv"><div class="k">When</div><div class="v" id="when">—</div></div>
      <div class="kv"><div class="k">Issuer</div><div class="v" id="issuer">—</div></div>
      <div class="kv"><div class="k">Kind</div><div class="v" id="kind">—</div></div>
      <div class="kv"><div class="k">Flags</div><div class="v" id="flags">—</div></div>
      <div class="kv" id="metricsRow" style="display:none"><div class="k">Metrics</div><div class="v" id="metrics">—</div></div>
      <div class="kv" id="basisRow" style="display:none"><div class="k">Basis</div><div class="v" id="basis">—</div></div>
      <div class="kv"><div class="k">Signature</div><div class="v"><code id="sigcode">—</code></div></div>
      <div class="kv"><div class="k">Verify</div>
        <div class="v">
          <div class="btnrow">
            <button id="verifyBtn" class="primary">Verify signature</button>
            <a id="downloadBtn" class="btn secondary" download>Download JSON</a>
            <button id="copyBtn" class="secondary">Copy link</button>
          </div>
          <div id="verifyStatus" class="small" style="margin-top:8px"></div>
        </div>
      </div>
    </div>

    <aside class="side">
      <div class="box">
        <strong>Load a receipt</strong>
        <label>Source</label>
        <select id="sourceSel">
          <option value="latest">Latest (receipt.latest.json)</option>
          <option value="pick">Pick from index (if present)</option>
          <option value="custom">Enter path</option>
        </select>
        <div id="customWrap" style="display:none">
          <label>Path (relative to /docs/)</label>
          <input type="text" id="customPath" placeholder="receipts/amber/ar_2025-...json" />
          <div class="btnrow" style="margin-top:8px"><button id="loadCustom" class="secondary">Load</button></div>
        </div>
        <div id="indexWrap" style="display:none">
          <div class="small">If <code>receipts/index.json</code> exists, you’ll see items below.</div>
          <div class="list" id="list"></div>
        </div>
        <div class="sep"></div>
        <strong>Public key</strong>
        <div class="small">Verification looks for <code>issuer.pub.json</code> (ed25519 hex). If missing, we’ll show how to add it.</div>
      </div>

      <div class="foot">
        Built for clarity (Gates), delight (Jobs), and boldness (Knight). All verification runs locally.
      </div>
    </aside>
  </div>
</div>

<script>
/* Minimal tweetnacl (ed25519) import — via cdn is fine on Pages */
const loadNaCl = () => new Promise((res, rej) => {
  const s=document.createElement('script');
  s.src='https://cdn.jsdelivr.net/npm/tweetnacl@1.0.3/nacl-fast.min.js';
  s.onload=()=>res(window.nacl);
  s.onerror=()=>rej(new Error('Failed to load tweetnacl'));
  document.head.appendChild(s);
});

const $ = (id)=>document.getElementById(id);
const state = { receipt:null, pubkeyHex:null, base:'', hasIndex:false, index:null };

function setPill(badge, kind){
  const pill = $('pill');
  pill.className = 'pill';
  const map = {
    green: 'badge-green',
    amber: 'badge-amber',
    gold: 'badge-gold',
    eval: 'badge-eval',
    label: 'badge-label'
  };
  if(map[badge]) pill.classList.add(map[badge]);
  pill.textContent = (badge||'—').toUpperCase() + (kind?` • ${kind}`:'');
}

function fmtWhen(s){
  if(!s) return '—';
  const d = /^\d+$/.test(String(s)) ? new Date(Number(s)*1000) : new Date(s);
  return d.toLocaleString();
}

function render(rec){
  state.receipt = rec;
  $('rid').textContent = rec.rid || '—';
  setPill(rec.what?.badge, rec.what?.kind);
  $('when').textContent = fmtWhen(rec.when);
  $('issuer').textContent = rec.issuer || '—';
  $('kind').textContent = rec.what?.kind || '—';
  $('flags').textContent = (rec.flags && rec.flags.length)? rec.flags.join(', ') : '—';
  $('sigcode').textContent = (rec.sig||'').slice(0,20)+'…';
  // optional blocks
  if(rec.metrics){ $('metricsRow').style.display='grid'; $('metrics').textContent = Object.entries(rec.metrics).map(([k,v])=>`${k}=${v}`).join(' · ');}
  else { $('metricsRow').style.display='none'; }
  if(rec.basis || rec.policy_checks){
    $('basisRow').style.display='grid';
    const b1 = rec.basis? Object.entries(rec.basis).map(([k,v])=>`${k}=${Array.isArray(v)?v.join('|'):v}`).join(' · ') : '';
    const b2 = rec.policy_checks? ' | checks: ' + Object.entries(rec.policy_checks).map(([k,v])=>`${k}:${v}`).join(', ') : '';
    $('basis').textContent = (b1+b2).trim() || '—';
  } else { $('basisRow').style.display='none'; }
  // buttons
  $('verifyStatus').textContent='';
  const dl = $('downloadBtn'); dl.href = state.currentHref || (state.base + 'receipt.latest.json');
  const cp = $('copyBtn'); cp.onclick = ()=>{ navigator.clipboard.writeText(dl.href).then(()=>{ $('verifyStatus').textContent='Link copied.'}) };
}

async function fetchJSON(path){
  const r = await fetch(path, {cache:'no-store'});
  if(!r.ok) throw new Error('Failed to load '+path);
  return await r.json();
}

async function loadLatest(){
  const href = state.base + 'receipt.latest.json';
  state.currentHref = href;
  const rec = await fetchJSON(href);
  render(rec);
}
async function loadCustomPath(p){
  const href = state.base + p.replace(/^\/?/,'');
  state.currentHref = href;
  const rec = await fetchJSON(href);
  render(rec);
}

async function tryLoadIndex(){
  try{
    const idx = await fetchJSON(state.base + 'receipts/index.json');
    state.hasIndex = true; state.index = idx;
    const list = $('list'); list.innerHTML='';
    ['amber','eval','label','promote'].forEach(group=>{
      if(idx[group]?.length){
        const h = document.createElement('div'); h.className='small'; h.style.margin='6px 0 4px'; h.textContent = group.toUpperCase();
        list.appendChild(h);
        idx[group].slice(0,8).forEach(item=>{
          const row = document.createElement('div'); row.className='item';
          const left = document.createElement('div'); left.textContent = item.rid;
          const right = document.createElement('div'); right.className='tag'; right.textContent = item.when || '';
          row.appendChild(left); row.appendChild(right);
          row.onclick = ()=> loadCustomPath(item.path);
          list.appendChild(row);
        });
      }
    });
  }catch(_){ state.hasIndex=false; }
}

async function tryLoadPub(){
  try{
    const pub = await fetchJSON(state.base + 'issuer.pub.json');
    if(!pub.ed25519_public_key_hex) throw 0;
    state.pubkeyHex = pub.ed25519_public_key_hex.replace(/^0x/,'');
  }catch(_){ state.pubkeyHex=null; }
}

async function verify(){
  const el = $('verifyStatus');
  el.textContent = 'Verifying…';
  if(!state.pubkeyHex){ el.innerHTML = 'Missing public key. Add <code>docs/issuer.pub.json</code> like:<br><code>{ "issuer": "did:web:openline.local", "ed25519_public_key_hex": "ABCDEF..." }</code>'; return; }
  const rec = {...state.receipt}; if(!rec || !rec.sig){ el.textContent='No signature found.'; return; }
  const sigHex = rec.sig; delete rec.sig;
  // canonicalize: sort keys recursively, no spaces
  const canonical = JSON.stringify(sortKeysDeep(rec));
  try{
    await loadNaCl();
    const nacl = window.nacl;
    const msg = new TextEncoder().encode(canonical);
    const sig = hexToBytes(sigHex);
    const pk = hexToBytes(state.pubkeyHex);
    const ok = nacl.sign.detached.verify(msg, sig, pk);
    el.innerHTML = ok ? '<span class="good">Signature valid ✔</span>' : '<span class="err">Signature failed ✖</span>';
  }catch(e){
    el.innerHTML = '<span class="err">Verify error: '+(e.message||e)+'</span>';
  }
}

function sortKeysDeep(obj){
  if(Array.isArray(obj)) return obj.map(sortKeysDeep);
  if(obj && typeof obj==='object'){
    const out={};
    Object.keys(obj).sort().forEach(k=>{ out[k]=sortKeysDeep(obj[k]); });
    return out;
  }
  return obj;
}
function hexToBytes(h){
  const s = h.length%2? '0'+h:h;
  const arr=new Uint8Array(s.length/2);
  for(let i=0;i<s.length;i+=2) arr[i/2]=parseInt(s.substr(i,2),16);
  return arr;
}

// UI hookups
$('verifyBtn').onclick = verify;
$('sourceSel').onchange = (e)=>{
  const v = e.target.value;
  $('customWrap').style.display = v==='custom'?'block':'none';
  $('indexWrap').style.display = v==='pick'?'block':'none';
  if(v==='latest') loadLatest();
};
$('loadCustom').onclick = ()=>{
  const p = $('customPath').value.trim();
  if(p) loadCustomPath(p);
};

// boot
(async function init(){
  // Pages serves this file at /<repo>/ — detect base path to /docs/
  // When using Pages root as /, files live at same path; we keep relative links.
  state.base = ''; // same folder as index.html
  await Promise.all([tryLoadIndex(), tryLoadPub()]);
  await loadLatest().catch(err=>{
    // fallback messaging
    render({rid:'—',when:null,issuer:'—',what:{badge:'amber',kind:'case'},flags:['—'],sig:''});
    $('verifyStatus').innerHTML = '<span class="err">Could not load receipt.latest.json</span>';
    console.error(err);
  });
})();
</script>
</body>
</html>
