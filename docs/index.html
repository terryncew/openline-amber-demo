<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Receipts Viewer — OLR/1.5 (back-compat)</title>
<meta name="color-scheme" content="dark">
<style>
  :root{
    --bg:#0b0c0f; --card:#10131a; --muted:#94a3b8; --text:#e5e7eb;
    --ok:#16a34a; --warn:#f59e0b; --red:#ef4444; --accent:#60a5fa;
    --border:#1f2632; --pill:#0f1720; --shadow:0 10px 28px rgba(0,0,0,.28);
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--text);
    font:16px/1.55 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
  .wrap{max-width:1024px;margin:0 auto;padding:28px 16px 56px}
  header{display:flex;gap:14px;align-items:center;justify-content:space-between;margin-bottom:14px}
  h1{font-size:22px;margin:0}
  .sub{color:var(--muted);font-size:14px}
  .hero{background:linear-gradient(180deg,rgba(96,165,250,.14),transparent 60%);
    border:1px solid var(--border);border-radius:14px;padding:14px 16px;margin:8px 0 16px}
  .grid{display:grid;grid-template-columns:1fr;gap:16px}
  @media(min-width:940px){.grid{grid-template-columns:1.1fr 340px}}
  .card{background:var(--card);border:1px solid var(--border);
    border-radius:16px;box-shadow:var(--shadow)}
  .hd{display:flex;justify-content:space-between;align-items:center;
    padding:14px 16px;border-bottom:1px solid var(--border)}
  .pill{display:inline-flex;gap:8px;align-items:center;background:var(--pill);
    border:1px solid var(--border);border-radius:999px;padding:6px 10px;
    font-weight:700;font-size:12px;letter-spacing:.2px}
  .badge-green{color:#86efac;border-color:#14532d;background:rgba(22,163,74,.09)}
  .badge-amber{color:#fde68a;border-color:#7c580b;background:rgba(245,158,11,.10)}
  .badge-red{color:#fecaca;border-color:#7f1d1d;background:rgba(239,68,68,.10)}
  .kv{display:grid;grid-template-columns:150px 1fr;gap:10px;padding:12px 16px;border-bottom:1px solid var(--border)}
  .kv:last-child{border-bottom:none}
  .k{color:var(--muted)}
  .v code{background:#0b1220;border:1px solid #1f2937;padding:2px 6px;border-radius:6px}
  .btnrow{display:flex;flex-wrap:wrap;gap:12px;margin-top:8px}
  .btn{
    appearance:none;border:none;cursor:pointer;border-radius:14px;
    padding:16px 18px;font-weight:800;letter-spacing:.25px;min-width:180px;
    background:#111827;color:#e5e7eb;border:1px solid #273142;touch-action:manipulation
  }
  .btn.primary{background:#1e40af;border-color:#1e3a8a}
  .btn.secondary{background:#0f172a;border-color:#233044}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .side{position:sticky;top:18px}
  .box{background:var(--card);border:1px solid var(--border);
    border-radius:14px;padding:14px}
  .small{font-size:12px;color:var(--muted)}
  select,input[type="text"]{width:100%;background:#0b1220;border:1px solid #253041;
    color:#e5e7eb;border-radius:10px;padding:12px 12px;font-size:14px}
  .sep{height:1px;background:var(--border);margin:14px 0}
  a{color:var(--accent);text-decoration:none}
  .story{border-left:4px solid #334155}
  .story.green{border-left-color:#16a34a}
  .story.amber{border-left-color:#f59e0b}
  .story.red{border-left-color:#ef4444}
  .dialrow{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .chip{font-size:12px;border:1px solid #334155;border-radius:10px;padding:6px 8px;background:#0c121a}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>Receipts Viewer</h1>
      <div class="sub">OLR/1.5 · backward-compatible</div>
    </div>
    <div class="sub">Portable proof. No prompts or PII.</div>
  </header>

  <div class="hero">
    <p><b>3-step demo:</b> 1) Load the latest receipt. 2) (Optional) Verify signature if present. 3) Read the story box.</p>
  </div>

  <!-- Story -->
  <div class="card story" id="storyCard" style="margin-bottom:16px">
    <div class="hd"><div class="pill" id="summaryPill">SUMMARY</div></div>
    <div class="kv"><div class="k">What happened</div><div class="v" id="summaryWhat">—</div></div>
    <div class="kv"><div class="k">Why it matters</div><div class="v" id="summaryWhy">—</div></div>
    <div class="kv" id="summaryNextRow" style="display:none"><div class="k">Next step</div><div class="v" id="summaryNext">—</div></div>
  </div>

  <div class="grid">
    <!-- Receipt detail -->
    <div class="card" id="card">
      <div class="hd">
        <div id="pill" class="pill">Loading…</div>
        <div class="sub" id="rid">—</div>
      </div>
      <div class="kv"><div class="k">When</div><div class="v" id="when">—</div></div>
      <div class="kv"><div class="k">Issuer</div><div class="v" id="issuer">—</div></div>
      <div class="kv"><div class="k">Policy</div><div class="v" id="policy">—</div></div>
      <div class="kv"><div class="k">Signals</div><div class="v" id="signals">—</div></div>
      <div class="kv" id="dialsRow" style="display:none"><div class="k">Dials (q8)</div>
        <div class="v" id="dials">
          <div class="dialrow">
            <span class="chip">∂Φ/∂κ: <b id="grad">—</b></span>
            <span class="chip">d²Φ/dt²: <b id="curv">—</b></span>
            <span class="chip">freshness: <b id="fresh">—</b></span>
          </div>
          <div class="small" style="margin-top:6px">q8 maps [-1..+1] → [0..255], 128 ≈ 0</div>
        </div>
      </div>
      <div class="kv"><div class="k">Guards</div><div class="v" id="guards">—</div></div>
      <div class="kv" id="sigRow" style="display:none"><div class="k">Signature</div><div class="v"><code id="sigcode">—</code></div></div>
      <div class="kv">
        <div class="k">Actions</div>
        <div class="v">
          <div class="btnrow">
            <button id="verifyBtn" class="btn primary" disabled>Verify signature</button>
            <a id="downloadBtn" class="btn secondary" download>Download JSON</a>
            <button id="copyBtn" class="btn secondary">Copy link</button>
          </div>
          <div id="verifyStatus" class="small" style="margin-top:10px"></div>
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <aside class="side">
      <div class="box">
        <strong>Load a receipt</strong>
        <div class="sep" style="margin:8px 0"></div>
        <label class="small">Source</label>
        <select id="sourceSel">
          <option value="latest">Latest (receipt.latest.json)</option>
          <option value="custom">Enter path</option>
        </select>

        <div id="customWrap" style="display:none;margin-top:10px">
          <label class="small">Path (relative to /docs/)</label>
          <input type="text" id="customPath" placeholder="receipts/demo/2025-…json" />
          <div class="btnrow" style="margin-top:8px"><button id="loadCustom" class="btn secondary">Load</button></div>
        </div>

        <div class="sep"></div>
        <strong>Public key</strong>
        <div class="small" id="pkHelp">Optional: add <code>docs/issuer.pub.json</code> (ed25519 hex) to enable “Verify”.</div>
      </div>

      <div class="box" style="margin-top:12px">
        <strong>What the badges mean</strong>
        <div class="small" style="margin-top:6px">
          <b>Green</b>: within thresholds.<br/>
          <b>Amber</b>: uncertain or approaching limits (dials show).<br/>
          <b>Red</b>: guardrails tripped (stop/route).
        </div>
      </div>
    </aside>
  </div>
</div>

<script>
/* tweetnacl (ed25519) for signature verify */
const loadNaCl = () => new Promise((res, rej) => {
  const s=document.createElement('script');
  s.src='https://cdn.jsdelivr.net/npm/tweetnacl@1.0.3/nacl-fast.min.js';
  s.onload=()=>res(window.nacl);
  s.onerror=()=>rej(new Error('Failed to load tweetnacl'));
  document.head.appendChild(s);
});

const $ = (id)=>document.getElementById(id);
const state = { receipt:null, pubkeyHex:null, base:'', currentHref:null };

/* ---------- helpers ---------- */
function setBadgePill(el, status){
  el.className = 'pill';
  const map = {green:'badge-green', amber:'badge-amber', red:'badge-red'};
  if(map[status]) el.classList.add(map[status]);
  el.textContent = status ? status.toUpperCase() : '—';
}
function fmtWhen(s){
  if(!s) return '—';
  const d = /^\d+$/.test(String(s)) ? new Date(Number(s)*1000) : new Date(s);
  return d.toLocaleString();
}
function q8byteToFloat(b){ const x=(Number(b)-128)/127; return Math.max(-1, Math.min(1, x)); }
function sortKeysDeep(obj){
  if(Array.isArray(obj)) return obj.map(sortKeysDeep);
  if(obj && typeof obj==='object'){
    const out={}; Object.keys(obj).sort().forEach(k=>out[k]=sortKeysDeep(obj[k])); return out;
  }
  return obj;
}
function hexToBytes(h){
  const s = (h||'').replace(/^0x/,'');
  const arr=new Uint8Array(Math.floor(s.length/2));
  for(let i=0;i<arr.length;i++) arr[i]=parseInt(s.substr(i*2,2),16)||0;
  return arr;
}

/* ---------- back-compat mappers ---------- */
function pickStatus(rec){
  return String(
    rec?.attrs?.status ??
    rec?.what?.badge ??
    rec?.status ??
    ''
  ).toLowerCase();
}
function pickRunId(rec){
  return rec?.attrs?.run_id ?? rec?.rid ?? '—';
}
function pickTs(rec){
  return rec?.attrs?.ts ?? rec?.when ?? rec?.t ?? null;
}
function pickSignals(rec){
  // OLR/1.5
  const s = rec?.signals;
  if (s && (('kappa' in s) || ('dhol' in s) || ('evidence_strength' in s))) return {
    kappa: s.kappa, dhol: s.dhol, es: s.evidence_strength
  };
  // Legacy: metrics or openline_frame.telem
  const m = rec?.metrics || rec?.openline_frame?.telem || {};
  return {
    kappa: m.kappa ?? m.kappa_eff ?? m.k,
    dhol:  m.dhol  ?? m.delta_hol,
    es:    m.evidence_strength ?? m.es
  };
}
function pickGuards(rec){
  // OLR/1.5
  const g = rec?.guards;
  if (g && (('ucr' in g) || ('cycles' in g) || ('contradictions' in g))) return {
    ucr:g.ucr, cycles:g.cycles, X:g.contradictions
  };
  // Legacy: digest (cycle_plus, x_frontier)
  const d = rec?.digest || rec?.openline_frame?.digest || {};
  return { ucr:d.ucr, cycles:d.cycle_plus, X:d.x_frontier };
}

/* ---------- story ---------- */
function fillStory(status){
  const storyCard = $('storyCard'); storyCard.className = 'card story ' + (status||'');
  setBadgePill($('summaryPill'), status);

  let what='—', why='—', next=null;
  if(status==='green'){ what='Guardrails within thresholds.'; why='Stable operation (no action needed).'; }
  else if(status==='amber'){
    what='Uncertain / approaching-limit case captured (no prompts or content saved—just tiny facts).';
    why='Amber routes tricky cases to experiments so we learn without training on junk.';
    next='Run a quick eval/label; if resolved, promote to training.';
  } else if(status==='red'){
    what='Guardrails tripped (stop or route).';
    why='Protects integrity: fix inputs or structure, then re-run.';
    next='Reduce κ or drift; add evidence; retry.';
  } else { what='Receipt loaded.'; why='Use Download to inspect the raw JSON.'; }
  $('summaryWhat').textContent=what; $('summaryWhy').textContent=why;
  if(next){ $('summaryNextRow').style.display='grid'; $('summaryNext').textContent=next; }
  else { $('summaryNextRow').style.display='none'; }
}

/* ---------- render ---------- */
function render(rec){
  state.receipt=rec;

  const status = pickStatus(rec);
  const runId  = pickRunId(rec);
  const ts     = pickTs(rec);
  const pol    = rec?.policy || {};
  const sigHex = rec?.sig;

  $('rid').textContent = runId;
  setBadgePill($('pill'), status);
  $('when').textContent = fmtWhen(ts);
  $('issuer').textContent = rec?.issuer || 'openline-demo';
  $('policy').textContent = pol?.policy_id ? `${pol.policy_id}${pol.policy_hash?' · '+pol.policy_hash.slice(0,14)+'…':''}` : '—';

  // signals (new or legacy)
  const S = pickSignals(rec);
  const parts=[];
  if(Number.isFinite(+S.kappa)) parts.push(`κ=${(+S.kappa).toFixed(3)}`);
  if(Number.isFinite(+S.dhol))  parts.push(`Δhol=${(+S.dhol).toFixed(3)}`);
  if(Number.isFinite(+S.es))    parts.push(`ES=${(+S.es).toFixed(2)}`);
  $('signals').textContent = parts.length? parts.join(' · ') : '—';

  // dials (only on non-green; new receipts only)
  const d = rec?.telem?.dials || {};
  if(status!=='green' && 'dphi_dk_q8' in d && 'd2phi_dt2_q8' in d && 'fresh_ratio_q8' in d){
    $('dialsRow').style.display='grid';
    $('grad').textContent  = q8byteToFloat(d.dphi_dk_q8).toFixed(2);
    $('curv').textContent  = q8byteToFloat(d.d2phi_dt2_q8).toFixed(2);
    $('fresh').textContent = q8byteToFloat(d.fresh_ratio_q8).toFixed(2);
  } else { $('dialsRow').style.display='none'; }

  // guards (new or legacy)
  const G = pickGuards(rec);
  const gparts=[];
  if(Number.isFinite(+G.ucr))    gparts.push(`UCR=${(+G.ucr).toFixed(2)}`);
  if(Number.isFinite(+G.cycles)) gparts.push(`cycles=${G.cycles}`);
  if(Number.isFinite(+G.X))      gparts.push(`X=${G.X}`);
  $('guards').textContent = gparts.length? gparts.join(' · ') : '—';

  // signature (optional)
  const hasSig = typeof sigHex === 'string' && sigHex.length >= 8;
  $('sigRow').style.display = hasSig ? 'grid':'none';
  $('verifyBtn').disabled   = true;
  $('verifyStatus').textContent = '';
  if(hasSig){
    $('sigcode').textContent = sigHex.slice(0, 32)+'…';
    $('verifyBtn').disabled = !state.pubkeyHex;
  }

  // buttons
  const dl = $('downloadBtn');
  dl.href = state.currentHref || (state.base + 'receipt.latest.json');
  $('copyBtn').onclick = ()=>navigator.clipboard.writeText(dl.href)
      .then(()=>{$('verifyStatus').textContent='Link copied.'});

  // story
  fillStory(status);
}

/* ---------- data ---------- */
async function fetchJSON(path){
  const r = await fetch(path, {cache:'no-store'}); if(!r.ok) throw new Error('Failed '+path);
  return await r.json();
}
async function loadLatest(){
  const href = state.base + 'receipt.latest.json';
  state.currentHref=href; const rec = await fetchJSON(href); render(rec);
}
async function loadCustomPath(p){
  const href = state.base + p.replace(/^\/?/,''); state.currentHref=href;
  const rec = await fetchJSON(href); render(rec);
}
async function tryLoadPub(){
  try{
    const pub = await fetchJSON(state.base + 'issuer.pub.json');
    if(!pub.ed25519_public_key_hex) throw 0;
    state.pubkeyHex = pub.ed25519_public_key_hex.replace(/^0x/,'');
    $('pkHelp').innerHTML = `Public key loaded ✅ <code>${pub.ed25519_public_key_hex.slice(0,12)}…</code>`;
  }catch(_){
    state.pubkeyHex=null;
    $('pkHelp').innerHTML = `Optional: add <code>docs/issuer.pub.json</code> like:<br>
<code>{ "issuer": "did:web:openline.local", "ed25519_public_key_hex": "ABCDEF..." }</code>`;
  }
}

/* ---------- verify ---------- */
$('verifyBtn').onclick = async ()=>{
  const el = $('verifyStatus'); el.textContent='Verifying…';
  const rec = JSON.parse(JSON.stringify(state.receipt||{}));
  if(!rec.sig){ el.innerHTML = '<span style="color:#fecaca">No signature on receipt.</span>'; return; }
  if(!state.pubkeyHex){ el.innerHTML = '<span style="color:#fecaca">No public key loaded.</span>'; return; }
  const sigHex = rec.sig; delete rec.sig;
  const canonical = JSON.stringify(sortKeysDeep(rec));
  try{
    await loadNaCl();
    const ok = window.nacl.sign.detached.verify(
      new TextEncoder().encode(canonical),
      hexToBytes(sigHex),
      hexToBytes(state.pubkeyHex)
    );
    el.innerHTML = ok ? '<span style="color:#86efac">Signature valid ✔</span>' :
                        '<span style="color:#fecaca">Signature failed ✖</span>';
  }catch(e){
    el.innerHTML = '<span style="color:#fecaca">Verify error: '+(e.message||e)+'</span>';
  }
};

/* ---------- UI events ---------- */
$('sourceSel').onchange = (e)=>{
  const v=e.target.value;
  $('customWrap').style.display = v==='custom'?'block':'none';
  if(v==='latest') loadLatest().catch(()=>{});
};
$('loadCustom').onclick = ()=>{
  const p = $('customPath').value.trim();
  if(p) loadCustomPath(p);
};

/* ---------- boot ---------- */
(async function init(){
  state.base=''; // files live alongside this page
  await tryLoadPub();
  await loadLatest().catch(err=>{
    // fallback demo frame
    render({attrs:{status:'amber',ts:null,run_id:'—'},signals:{},guards:{}});
    console.warn(err);
  });
})();
</script>
</body>
</html>
